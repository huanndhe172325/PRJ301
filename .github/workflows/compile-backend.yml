# -----------------------------------------------------
# Workflow: Build & Test Java Backend
# EN: Sets up JDK 17, compiles, and tests the backend using Maven Wrapper (./mvnw)
# VI: Thi·∫øt l·∫≠p JDK 17, bi√™n d·ªãch v√† ch·∫°y test cho backend b·∫±ng Maven Wrapper (./mvnw)
# Trigger: Runs on push or pull request
# -----------------------------------------------------

name: Build & Test Java Backend

on: [push, pull_request]

jobs:
  build:
    name: üß± Compile Backend Code
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      # B∆∞·ªõc 1: L·∫•y m√£ ngu·ªìn t·ª´ repository
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for versioning metadata

      # Step 2: Set up JDK 17 with Maven dependency caching
      # B∆∞·ªõc 2: C√†i ƒë·∫∑t JDK 17 v√† b·∫≠t cache Maven
      - name: Set up Java environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      # Step 3: Configure UTF-8 encoding for build consistency
      # B∆∞·ªõc 3: Thi·∫øt l·∫≠p encoding UTF-8 ƒë·ªÉ tr√°nh l·ªói k√Ω t·ª±
      - name: Configure Maven environment
        run: echo "MAVEN_OPTS=-Dfile.encoding=UTF-8" >> $GITHUB_ENV

      # Step 4: Compile backend using Maven Wrapper
      # B∆∞·ªõc 4: Bi√™n d·ªãch m√£ ngu·ªìn b·∫±ng Maven Wrapper
      - name: Compile backend
        working-directory: app
        run: |
          chmod +x mvnw
          ./mvnw -B clean compile \
            -Dproject.build.sourceEncoding=UTF-8 \
            -Dproject.reporting.outputEncoding=UTF-8

  test:
    name: ‚úÖ Run Unit Tests
    runs-on: ubuntu-latest
    needs: build  # Ensure compilation completes before testing
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Run Maven tests
        working-directory: app
        run: |
          chmod +x mvnw
          ./mvnw -B test

  notify:
    name: üì¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [build, test]
    if: failure()
    steps:
      - name: Send failure notification
        run: echo "‚ùå Build or tests failed. Please review the GitHub Actions logs for details."
